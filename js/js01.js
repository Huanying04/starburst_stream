var bac_暫存;var int_編輯size=300;var int_儲存size=900;var int_儲存素材size=512;var int_儲存素材size_w=0;var int_儲存素材size_h=0;document.onload=function(){var b=document.getElementById("file_input");if(typeof FileReader==="undefined"){alert("抱歉，你的瀏覽器不支持 FileReader");b.setAttribute("disabled","disabled")}else{b.addEventListener("change",a,false)}function a(){var d=this.files[0];if(!/image\/\w+/.test(d.type)){alert("文件必須為圖片！");return false}var c=new FileReader();c.readAsDataURL(d);c.onload=function(f){var g=this.result;fun_開啟圖片後初始化size(g)}}bac_暫存=document.getElementById("bac01");fun_啟動程式初始化size()};function fun_啟動程式初始化size(){var m=int_編輯size;var h=document.getElementById("m_top").offsetWidth;var k=document.getElementById("m_top").offsetHeight;if(h>m||k>m){var a=h/m;var l=k/m;if(a>l){h=h/a;k=k/a}else{h=h/l;k=k/l}}bac_暫存.width=h*2;bac_暫存.height=k*2;int_儲存素材size_w=h*1.5;int_儲存素材size_h=k*1.5;document.getElementById("bac").width=h;document.getElementById("bac").height=k;for(var f=0;f<int_nub;f++){document.getElementById("x3d"+f).style.width=h+"px";document.getElementById("x3d"+f).style.height=k+"px"}var c=(document.getElementById("m_top").offsetWidth*0.98)/h;var g=(document.getElementById("m_top").offsetHeight*0.98)/k;var d=c;if(c>g){d=g}var b=(document.getElementById("m_top").offsetWidth-h*d)/2;var j=(document.getElementById("m_top").offsetHeight-k*d)/2;var e="transform:scale("+d+");left:"+b+"px;top:"+j+"px";document.getElementById("top_box").setAttribute("style",e)}function fun_計算暫存(e){var d=int_儲存size;nWidth=e.naturalWidth;nHeight=e.naturalHeight;if(nWidth>d||nHeight>d){var g=nWidth/d;var b=nHeight/d;if(g>b){nWidth=nWidth/g;nHeight=nHeight/g}else{nWidth=nWidth/b;nHeight=nHeight/b}}bac_暫存.width=nWidth;bac_暫存.height=nHeight;var f=bac_暫存;var a=f.getContext("2d");a.drawImage(e,0,0,nWidth,nHeight)}function fun_開啟圖片後初始化size(b){var a=new Image();a.src=b;a.onload=function(){fun_計算暫存(this);fun_初始化素材size(this);var q=int_編輯size;var l=a.naturalWidth;var o=a.naturalHeight;if(l>q||o>q){var d=l/q;var p=o/q;if(d>p){l=l/d;o=o/d}else{l=l/p;o=o/p}}document.getElementById("bac").width=l;document.getElementById("bac").height=o;for(var j=0;j<int_nub;j++){document.getElementById("x3d"+j).style.width=l+"px";document.getElementById("x3d"+j).style.height=o+"px"}var m=document.getElementById("bac");var r=m.getContext("2d");r.drawImage(a,0,0,l,o);var f=(document.getElementById("m_top").offsetWidth*0.98)/l;var k=(document.getElementById("m_top").offsetHeight*0.98)/o;var g=f;if(f>k){g=k}var e=(document.getElementById("m_top").offsetWidth-l*g)/2;var n=(document.getElementById("m_top").offsetHeight-o*g)/2;var h="transform:scale("+g+");left:"+e+"px;top:"+n+"px";document.getElementById("top_box").setAttribute("style",h);a=null}}function fun_初始化素材size(c){var b=int_儲存素材size;nWidth=c.naturalWidth;nHeight=c.naturalHeight;if(nWidth>b||nHeight>b){var d=nWidth/b;var a=nHeight/b;if(d>a){nWidth=nWidth/d;nHeight=nHeight/d}else{nWidth=nWidth/a;nHeight=nHeight/a}}int_儲存素材size_w=nWidth;int_儲存素材size_h=nHeight}var ar_x3d=new Array();var ctx;var nWidth;var nHeight;var img_type;var imgData;var int_sum=0;function fun_save(f){fun_儲存圖片_關閉();var j=new Date();var a=j.getFullYear()+"-"+("00"+(j.getMonth()+1)).slice(-2)+"-"+("00"+j.getDate()).slice(-2)+" "+("00"+j.getHours()).slice(-2)+"-"+("00"+j.getMinutes()).slice(-2)+"-"+("00"+j.getSeconds()).slice(-2);if(f=="png_2"){a+=".png"}else{a+="."+f}document.getElementById("a_download").setAttribute("download",a);var c=document.getElementsByTagName("x3d");ar_x3d=new Array();for(var b=c.length-1;b>=0;b--){if(c[b].style.display!="none"){ar_x3d.push(c[b])}}if(ar_x3d.length==0){if(f=="jpg"){document.getElementById("a_download").href=bac_暫存.toDataURL("image/jpeg",0.8)}else{document.getElementById("a_download").href=bac_暫存.toDataURL("image/png",0.8)}document.getElementById("a_download").click();fun_儲存中_隱藏();return}fun_儲存中_顯示();try{}catch(h){}var g=bac_暫存;ctx=g.getContext("2d");nWidth=g.offsetWidth;nHeight=g.offsetHeight;imgData=ctx.getImageData(0,0,nWidth,nHeight);if(f=="png_2"){ctx.clearRect(0,0,nWidth,nHeight)}int_sum=0;j2=0;this.img_type=f;fun_save_1()}var j2=0;function fun_save_1(){if(j2>=ar_x3d.length){return}setTimeout("fun_save_2("+j2+");fun_save_1();",150);j2++}function fun_save_2(a){ar_x3d[a].style.width=int_儲存素材size_w+"px";ar_x3d[a].style.height=int_儲存素材size_h+"px";setTimeout(function(){var c=ar_x3d[a].runtime.getScreenshot();var b=new Image();b.src=c;ar_x3d[a].style.width=(document.getElementById("bac").offsetWidth)+"px";ar_x3d[a].style.height=(document.getElementById("bac").offsetHeight)+"px";b.onload=function(){int_sum++;ctx.drawImage(this,0,0,nWidth,nHeight);if(int_sum==ar_x3d.length){if(img_type=="jpg"){document.getElementById("a_download").href=bac_暫存.toDataURL("image/jpeg",0.8)}else{document.getElementById("a_download").href=bac_暫存.toDataURL("image/png",0.8)}document.getElementById("a_download").click();setTimeout(function(){ctx.clearRect(0,0,nWidth,nHeight);ctx.putImageData(imgData,0,0);fun_儲存中_隱藏()},300)}b=null}},50)};